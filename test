#authorize with admin token
vault auth $admintoken
#disable any existing plugin 
vault auth-disable exchange

#copy plugin to vault's plugin directory 
mv ./vault-exchange/pkg/darwin_386/vault-exchange $vault_path/plugin/

# clean existing log file
rm /tmp/vault-exchange.log

#install the plugin
SHASUM=$(shasum -a 256 $vault_path/plugin/vault-exchange | cut -d " " -f1)
vault write  sys/plugins/catalog/vault-exchange sha_256="$SHASUM" command="vault-exchange"
vault auth-enable  -path=exchange  -plugin-name=vault-exchange plugin

#configure the plugin to setup the root path for your teams secrets
vault write auth/exchange/config  display_name=exchange path=mycompany/myorg token=$admintoken

#register users
vault write auth/exchange/register  user=hardeep 
vault write auth/exchange/register  user=hardeep_s 


#write a secrets
vault auth -method=ldap username=hardeep
vault write secret/mycompany/myorg/hardeep/mysecrets value="the_secret"

#Share the secret
vault write auth/exchange/command/grant user=hardeep_s  path=mysecrets token=$usertoken

#read the shared secrets
vault auth -method=ldap username=hardeep_s
vault read secret/mycompany/myorg/hardeep/mysecrets

#revoke access to the secret
vault auth -method=ldap username=hardeep
vault write auth/exchange/command/revoke  user=hardeep_s  path=mysecrets token=$usertoken


